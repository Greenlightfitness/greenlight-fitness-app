
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- COLLECTION RULES ---

    // 1. Users: Users can read/write their own profile. Admins can manage all.
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin();
    }

    // 2. Exercises: 
    // - Read: Everyone.
    // - Create: Authenticated users (AuthorID must match).
    // - Update/Delete: Only the Author or Admin.
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isAdmin());
    }

    // 3. Plans:
    // - Create: Authenticated users.
    // - Read/Write: Owner (coachId) or Admin.
    match /plans/{planId} {
      allow create: if isAuthenticated() && request.resource.data.coachId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && (resource.data.coachId == request.auth.uid || isAdmin());

      // Sub-collections inherit ownership check from parent plan
      match /weeks/{weekId} {
        allow read, write: if isAuthenticated() && (get(/databases/$(database)/documents/plans/$(planId)).data.coachId == request.auth.uid || isAdmin());
        
        match /sessions/{sessionId} {
            allow read, write: if isAuthenticated() && (get(/databases/$(database)/documents/plans/$(planId)).data.coachId == request.auth.uid || isAdmin());
        }
      }
    }

    // 4. Assigned Plans (Snapshots):
    // - Create: Authenticated (e.g. Coach assigning or User buying).
    // - Read: Athlete (Owner of snapshot) OR Coach (Assigner) OR Admin.
    // - Write: Coach or Admin (usually updates schedule). Athlete can update schedule if it's their plan.
    match /assigned_plans/{docId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (resource.data.athleteId == request.auth.uid || resource.data.coachId == request.auth.uid || isAdmin());
      allow update, delete: if isAuthenticated() && (resource.data.athleteId == request.auth.uid || resource.data.coachId == request.auth.uid || isAdmin());
    }
    
    // 5. Products (Shop):
    // - Read: Everyone.
    // - Write: Admin or Coach (Owner).
    match /products/{docId} { 
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && (resource == null || resource.data.coachId == request.auth.uid || isAdmin()); 
    }

    // 6. Communication & Logging
    match /attentions/{docId} { allow read, write: if isAuthenticated(); }
    match /activities/{docId} { allow read, write: if isAuthenticated(); }
    match /appointments/{docId} { allow read, write: if isAuthenticated(); }
  }
}
